generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

model Usuario {
    id       String   @id @default(cuid())
    nombre   String
    apellido String
    usuario  String   @unique
    email    String   @unique
    telefono String   @unique
    password String
    sesiones Sesion[]
}

model Cliente {
    id                   String                 @id @default(cuid())
    nombre               String
    apellido             String?
    email                String?                @unique
    telefono             String?
    Pago                 Pago[]
    WhatsappNotification WhatsappNotification[]
    creado               DateTime               @default(now())
}

model Sesion {
    id        String   @id
    expira    DateTime
    usuarioId String
    usuario   Usuario  @relation(references: [id], fields: [usuarioId], onDelete: Cascade)
}

model Pago {
    id          String          @id @default(cuid())
    creado      DateTime        @default(now())
    actualizado DateTime        @updatedAt
    monto       Int
    estado      EstadoPago      @default(ABIERTO)
    membresia   EstadoMembresia
    cliente     Cliente         @relation(fields: [clienteId], references: [id], onDelete: Cascade)
    clienteId   String

    @@index([clienteId])
}

enum EstadoPago {
    ABIERTO
    PAGADO
    PENDIENTE
    FALLIDO
}

enum EstadoMembresia {
    DIARIO
    MENSUAL
}

// Notifications sent to clients via WhatsApp to avoid duplicates per cohort/month
model WhatsappNotification {
    id                String             @id @default(cuid())
    cliente           Cliente            @relation(fields: [clienteId], references: [id], onDelete: Cascade)
    clienteId         String
    cohort            NotificationCohort
    year              Int
    month             Int
    status            NotificationStatus
    providerMessageId String?
    error             String?
    createdAt         DateTime           @default(now())

    @@unique([clienteId, cohort, year, month])
    @@index([cohort, year, month])
}

enum NotificationCohort {
    PRE_EOM
    POST_EOM
}

enum NotificationStatus {
    SENT
    SKIPPED
    FAILED
}
