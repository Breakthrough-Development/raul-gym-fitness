generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

model User {
    id        String    @id @default(cuid())
    firstName String
    lastName  String
    username  String    @unique
    email     String    @unique
    phone     String    @unique
    password  String
    sessions  Session[]
}

model Client {
    id                   String                 @id @default(cuid())
    firstName            String
    lastName             String?
    email                String?                @unique
    phone                String?
    payments             Payment[]
    WhatsappNotification WhatsappNotification[]
    createdAt            DateTime               @default(now())
}

model Session {
    id        String   @id
    expiresAt DateTime
    userId    String
    user      User     @relation(references: [id], fields: [userId], onDelete: Cascade)
}

model Payment {
    id          String        @id @default(cuid())
    createdAt   DateTime      @default(now())
    updatedAt   DateTime      @updatedAt
    paymentDate DateTime      @default(now())
    amount      Int
    status      PaymentStatus @default(OPEN)
    membership  MembershipStatus
    client      Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
    clientId    String

    @@index([clientId])
}

enum PaymentStatus {
    OPEN
    PAID
    PENDING
    FAILED
}

enum MembershipStatus {
    DAILY
    MONTHLY
}

// Notifications sent to clients via WhatsApp to avoid duplicates per cohort/month
model WhatsappNotification {
    id                String             @id @default(cuid())
    client            Client              @relation(fields: [clientId], references: [id], onDelete: Cascade)
    clientId          String
    cohort            NotificationCohort
    year              Int
    month             Int
    status            NotificationStatus
    providerMessageId String?
    error             String?
    createdAt         DateTime           @default(now())

    @@unique([clientId, cohort, year, month])
    @@index([cohort, year, month])
}

enum NotificationCohort {
    PRE_EOM
    POST_EOM
}

enum NotificationStatus {
    SENT
    SKIPPED
    FAILED
}

// Scheduled notifications for WhatsApp messages
model ScheduledNotification {
    id                String                      @id @default(cuid())
    message           String // Description of the notification
    recipientType     RecipientType               @default(ALL)
    selectedClientIds String[] // Array of client IDs when recipientType is SELECTED
    membershipFilter  MembershipFilter? // Filter by membership type
    sendDate          DateTime // When to send the notification
    recurrence        RecurrenceType              @default(ONE_TIME)
    templateName      String // WhatsApp template name
    status            ScheduledNotificationStatus @default(PENDING)
    sentAt            DateTime? // When it was actually sent
    error             String? // Error message if failed
    createdAt         DateTime                    @default(now())
    updatedAt         DateTime                    @updatedAt

    // Relations - Note: selectedClientIds is stored as String[] for simplicity

    @@index([status, sendDate])
    @@index([recipientType])
}

enum RecipientType {
    ALL
    SELECTED
}

enum MembershipFilter {
    DAILY
    MONTHLY
    BOTH
}

enum RecurrenceType {
    ONE_TIME
    WEEKLY
    MONTHLY
}

enum ScheduledNotificationStatus {
    PENDING
    SENT
    FAILED
    CANCELLED
}
